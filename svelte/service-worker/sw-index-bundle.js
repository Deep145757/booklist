(function(){'use strict';function a(a){var b;switch(a.arrayFormat){case"index":return function(a,c,d){return b=/\[(\d*)\]$/.exec(a),a=a.replace(/\[\d*\]$/,""),b?void(void 0===d[a]&&(d[a]={}),d[a][b[1]]=c):void(d[a]=c)};case"bracket":return function(a,c,d){return b=/(\[\])$/.exec(a),a=a.replace(/\[\]$/,""),b&&void 0!==d[a]?void(d[a]=[].concat(d[a],c)):void(d[a]=c)};default:return function(a,b,c){return void 0===c[a]?void(c[a]=b):void(c[a]=[].concat(c[a],b))};}}function b(a){if(Array.isArray(a))return a.sort();return"object"==typeof a?b(Object.keys(a)).sort(function(c,a){return+c-+a}).map(function(b){return a[b]}):a}function c(c,d){d=Object.assign({arrayFormat:"none"},d);var e=a(d),f=Object.create(null);// Create an object with no prototype
// https://github.com/sindresorhus/query-string/issues/47
return"string"==typeof c?(c=c.trim().replace(/^(\?|#|&)/,""),!c)?f:(c.split("&").forEach(function(a){var b=a.replace(/\+/g," ").split("="),c=b.shift(),d=0<b.length?b.join("="):void 0;// Firefox (pre 40) decodes `%3D` to `=`
// https://github.com/sindresorhus/query-string/pull/37
d=void 0===d?null:decodeURIComponent(d),e(decodeURIComponent(c),d,f)}),Object.keys(f).sort().reduce(function(a,c){var d=f[c];return a[c]=!d||"object"!=typeof d||Array.isArray(d)?d:b(d),a},Object.create(null))):f}async function d(a=null){try{indexedDB.deleteDatabase("books")}catch(a){}f("mylibrary_io",L,a,(b,c)=>e(b,c,a))}async function e(a,b,c){if(!a.objectStoreNames.contains("books")){let b=a.createObjectStore("books",{keyPath:"_id"});b.createIndex("imgSync","imgSync",{unique:!1}),b.createIndex("title_ci","title_ci",{unique:!1}),b.createIndex("dateAdded","dateAdded",{unique:!1}),b.createIndex("pages","pages",{unique:!1})}if(a.objectStoreNames.contains("syncInfo")||(a.createObjectStore("syncInfo",{keyPath:"id"}),b.objectStore("syncInfo").add({id:1,usersSyncd:{}})),!a.objectStoreNames.contains("subjects")){let b=a.createObjectStore("subjects",{keyPath:"_id"});b.createIndex("name","name",{unique:!1})}if(!a.objectStoreNames.contains("tags")){let b=a.createObjectStore("tags",{keyPath:"_id"});b.createIndex("name","name",{unique:!1})}if(!a.objectStoreNames.contains("labelColors")){let b=a.createObjectStore("labelColors",{keyPath:"_id"});b.createIndex("order","order",{unique:!1})}b.oncomplete=()=>c(a)}function f(a,b,c,d){let e=indexedDB.open(a,b);e.onsuccess=async()=>{let a=e.result;c&&c(a)},e.onupgradeneeded=a=>{if(d){let b=e.result,c=a.target.transaction;d(b,c)}}}function g(a){if("string"!=typeof a)throw new TypeError("Expected a string");return a.replace(M,"\\$&")}async function h(){let[a={}]=await k("syncInfo");return a}function i(a){return new Promise(b=>{d(c=>{let d=c.transaction([a],"readonly"),e=d.objectStore(a),f=e.count();f.onsuccess=()=>b(f.result)})})}function j(a){let b,c,d=JSON.parse(a),{page:h=1,pageSize:i=50,title_contains:e,sort:f}=d,j=null,l=(h-1)*i;if(e){let a=new RegExp(g(e),"i");j=b=>a.test(b.title),c=0,b=l}else c=l,b=0;let m=f?Object.keys(f)[0]:null,n=f&&"_id"!=m?"pages"==m?"pages":"title_ci":"dateAdded",o=m&&-1==f[m]?"prev":void 0;return k("books",n,{predicate:j,skip:b,cursorSkip:c,limit:i,idxDir:o}).then(J("allBooks","Books"))}function k(a,b=null,{predicate:c,idxDir:e,cursorSkip:f,skip:g,limit:h}={}){return c||(c=()=>!0),new Promise(i=>{d(d=>{let j=d.transaction(a),k=j.objectStore(a),l=b?k.index(b).openCursor(null,e):k.openCursor(e),m=[],n=0,o=!1;l.onsuccess=a=>{let b=a.target.result;if(f&&!o)return o=!0,b.advance(f);if(!b)return i(m);let d=b.value;return c(d)&&(g&&n<g?n++:m.push(d),h&&m.length==h)?i(m):void b.continue()}})})}function l(a,b,c,{transformItem:d=a=>a}={}){return new Promise(e=>{function f(){let h=b[g++];if(!h)return e();let i=a.transaction(c,"readwrite"),j=i.objectStore(c);j.add(d(h)).onsuccess=f}if(!b)return e();let g=0;f()})}async function m(){for(let a of["books","subjects","tags"])await n(a)}async function n(a){return new Promise(b=>{d(async c=>{let d=c.transaction(a,"readwrite");d.objectStore(a).clear().onsuccess=b})})}async function o(a){let b=await h();return new Promise(c=>{d(d=>{let e=d.transaction("syncInfo","readwrite"),f=e.objectStore("syncInfo");"function"==typeof a?b=a(b):Object.assign(b,a),f.put(b).onsuccess=c})})}function p(a,b){return new Promise(c=>{d(d=>{let e=d.transaction(b,"readwrite"),f=e.objectStore(b);f.delete(a).onsuccess=c})})}async function q({request:a,response:b},c,d=a=>a){let e=`create${c}`;b&&b.data&&b.data[e]&&b.data[e][c]&&u(d(b.data[e][c]),`${c.toLowerCase()}s`);let f=`update${c}`;b&&b.data&&b.data[f]&&b.data[f][c]&&u(d(b.data[f][c]),`${c.toLowerCase()}s`);let g=`update${c}s`;b&&b.data&&b.data[g]&&b.data[g][c+"s"]&&b.data[g][c+"s"].forEach(a=>u(d(a),`${c.toLowerCase()}s`));if(b&&b.data&&b.data[`delete${c}`]){let b=await a.json();p(b.variables._id,c.toLowerCase()+"s")}}function r(a){a&&a.data&&a.data.updateSubject&&a.data.updateSubject.forEach(a=>u(a,`subjects`))}async function u(a,b,c=a=>a){const e=await h();let f=e.currentUser;return f?new Promise(e=>{d(d=>{let f=d.transaction(b,"readwrite"),g=f.objectStore(b);g.get(a._id).onsuccess=({target:{result:b}})=>{b?(Object.assign(b,c(a)),g.put(b).onsuccess=e):g.add(c(a)).onsuccess=e}})}):void 0}function v(a,b){return o(c=>(c.usersSyncd[a]=Object.assign(c.usersSyncd[a]||{},{lastSync:b}),c))}async function w(a,b){let c=`/graphql/?query=${15}&variables=${JSON.stringify({timestamp:b})}`,{data:d}=await I(c).then(a=>a.json());for(let c of d.allBooks.Books)await u(c,"books",K);for(let c of d.allSubjects.Subjects)await u(c,"subjects");for(let c of d.allTags.Tags)await u(c,"tags");for(let{_id:c}of d.deletedBooks._ids)await p(c,"books");for(let{_id:c}of d.deletedSubjects._ids)await p(c,"subjects");for(let{_id:c}of d.deletedTags._ids)await p(c,"tags");await v(a,+new Date)}function x(a){d(b=>{Promise.all([new Promise(a=>y(b,a)),z(b),A(b),B(b)]).then(()=>v(a,+new Date))})}function y(a,b,c=1){E(6,{page:c,pageSize:50},"allBooks","Books").then(d=>{l(a,d,"books",{transformItem:a=>Object.assign(a,{imgSync:0,title_ci:(a.title||"").toLowerCase()})}).then(()=>{d.length==50?y(a,b,c+1):C(a,b)})})}function z(a){return E(20,{},"allSubjects","Subjects").then(b=>l(a,b,"subjects"))}function A(a){return E(25,{},"allTags","Tags").then(b=>l(a,b,"tags"))}async function B(a){return 0<(await i("labelColors"))?void 0:E(14,{},"allLabelColors","LabelColors").then(b=>l(a,b,"labelColors"))}async function C(a,b){async function c(){return void b()}let d=a.transaction("books"),e=d.objectStore("books"),f=e.index("imgSync"),g=f.openCursor(0),h=[];g.onsuccess=a=>{let b=a.target.result;if(!b)return c();let d=b.value;h.push({_id:d._id,smallImage:d.smallImage}),b.continue()}}async function D(a){let b=a.smallImage;if(b){let a=await caches.match(b);if(!a){if(/https:\/\/s3.amazonaws.com\/my-library-cover-uploads/.test(b)){let a=await caches.open("local-images1"),c=await fetch(b,{mode:"cors",credentials:"omit"});return await a.put(b,c),!0}if(/https:\/\/images-na\.ssl-images-amazon\.com/.test(b)){let a=await caches.open("amazon-images1"),c=await fetch(b,{mode:"cors",credentials:"omit"});return await a.put(b,c),!0}if(/https:\/\/ecx\.images-amazon\.com/.test(b)){let a=await caches.open("amazon-images2"),c=await fetch(b,{mode:"cors",credentials:"omit"});return await a.put(b,c),!0}}}}function E(a,b,c,d){return I(`/graphql/?query=${a}&variables=${JSON.stringify(b)}`).then(a=>a.json()).then(a=>a.data&&a.data[c]&&a.data[c][d])}function F(a){return fetch(a).catch(()=>{let b=a.url.split("?")[1],{query:d,variables:e}=c(b);if(d==14)return k("labelColors","order").then(J("allLabelColors","LabelColors"));return 20==d?k("subjects","name").then(J("allSubjects","Subjects")):25==d?k("tags","name").then(J("allTags","Tags")):5==d?j(e):void 0})}function G(a){let b=a.clone();return fetch(a).then(a=>{console.log(b);let c=a.clone();return c.json().then(a=>{q({request:b,response:a},"Book",K),q({request:b,response:a},"Tag"),r(a)}),a})}function H(a){// 10 seconds
d(async()=>{await o({currentUser:a});let b=await h(),c=b.usersSyncd[a];c?Date.now()-c.lastSync>15000&&w(a,c.lastSync):x(a)})}const I=a=>fetch(a,{method:"get",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}),J=(a,b)=>c=>new Response(JSON.stringify({data:{[a]:{[b]:c}}})),K=a=>Object.assign(a,{title_ci:(a.title||"").toLowerCase()}),L=1;var M=/[|\\{}()[\]^$+*?.]/g;self.addEventListener("message",a=>{"sw-update-accepted"==a.data&&self.skipWaiting().then(()=>{self.clients.claim().then(()=>{self.clients.matchAll().then(a=>{a.forEach(a=>a.postMessage("sw-updated"))})})})}),self.addEventListener("push",()=>{self.registration.showNotification("Push notification received!")}),self.addEventListener("message",async a=>{a.data&&"do-sync"==a.data.command&&(await o({currentUser:a.data.userId}),H(a.data.userId))}),self.addEventListener("message",async a=>{a.data&&"login"==a.data.command&&(await o({currentUser:a.data.userId}),H(a.data.userId))}),self.addEventListener("message",async a=>{a.data&&"logged-out"==a.data.command&&(await o({currentUser:null,usersSyncd:{}}),await m())}),self.addEventListener("fetch",a=>{let b=a.request.clone();if(/\bgraphql\b/.test(b.url)){if(/get/i.test(b.method))return a.respondWith(F(b));if(/post/i.test(b.method))return a.respondWith(G(b))}})})();
