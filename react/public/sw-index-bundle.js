"use strict";function E(e){var t;switch(e.arrayFormat){case"index":return function(n,r,a){if(t=/\[(\d*)\]$/.exec(n),n=n.replace(/\[\d*\]$/,""),!t){a[n]=r;return}a[n]===void 0&&(a[n]={}),a[n][t[1]]=r};case"bracket":return function(n,r,a){if(t=/(\[\])$/.exec(n),n=n.replace(/\[\]$/,""),!t||a[n]===void 0){a[n]=r;return}a[n]=[].concat(a[n],r)};default:return function(n,r,a){if(a[n]===void 0){a[n]=r;return}a[n]=[].concat(a[n],r)}}}function q(e){return Array.isArray(e)?e.sort():typeof e=="object"?q(Object.keys(e)).sort(function(t,n){return Number(t)-Number(n)}).map(function(t){return e[t]}):e}function D(e,t){t=Object.assign({arrayFormat:"none"},t);var n=E(t),r=Object.create(null);return typeof e!="string"||(e=e.trim().replace(/^(\?|#|&)/,""),!e)?r:(e.split("&").forEach(function(a){var o=a.replace(/\+/g," ").split("="),s=o.shift(),c=o.length>0?o.join("="):void 0;c=c===void 0?null:decodeURIComponent(c),n(decodeURIComponent(s),c,r)}),Object.keys(r).sort().reduce(function(a,o){var s=r[o];return Boolean(s)&&typeof s=="object"&&!Array.isArray(s)?a[o]=q(s):a[o]=s,a},Object.create(null)))}const v=e=>fetch(e,{method:"get",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}),p=(e,t)=>n=>new Response(JSON.stringify({data:{[e]:{[t]:n}}})),x=e=>Object.assign(e,{title_ci:(e.title||"").toLowerCase()}),A=1;async function d(e=null){try{indexedDB.deleteDatabase("books")}catch{}F("mylibrary_io",A,e,(t,n)=>U(t,n,e))}async function U(e,t,n){if(!e.objectStoreNames.contains("books")){let r=e.createObjectStore("books",{keyPath:"_id"});r.createIndex("imgSync","imgSync",{unique:!1}),r.createIndex("title_ci","title_ci",{unique:!1}),r.createIndex("dateAdded","dateAdded",{unique:!1}),r.createIndex("pages","pages",{unique:!1})}e.objectStoreNames.contains("syncInfo")||(e.createObjectStore("syncInfo",{keyPath:"id"}),t.objectStore("syncInfo").add({id:1,usersSyncd:{}})),e.objectStoreNames.contains("subjects")||e.createObjectStore("subjects",{keyPath:"_id"}).createIndex("name","name",{unique:!1}),e.objectStoreNames.contains("tags")||e.createObjectStore("tags",{keyPath:"_id"}).createIndex("name","name",{unique:!1}),e.objectStoreNames.contains("labelColors")||e.createObjectStore("labelColors",{keyPath:"_id"}).createIndex("order","order",{unique:!1}),t.oncomplete=()=>n(e)}function F(e,t,n,r){let a=indexedDB.open(e,t);a.onsuccess=async o=>{let s=a.result;n&&n(s)},a.onupgradeneeded=o=>{if(r){let s=a.result,c=o.target.transaction;r(s,c)}}}var J=/[|\\{}()[\]^$+*?.]/g;function G(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(J,"\\$&")}async function _(){let[e={}]=await S("syncInfo");return e}function Q(e){return new Promise(t=>{d(n=>{let o=n.transaction([e],"readonly").objectStore(e).count();o.onsuccess=()=>t(o.result)})})}function z(e){let t=JSON.parse(e),{page:n=1,pageSize:r=50,title_contains:a,sort:o}=t,s=null,c=r,i=(n-1)*r,l,u;if(a){let h=new RegExp(G(a),"i");s=k=>h.test(k.title),u=0,l=i}else u=i,l=0;let b=o?Object.keys(o)[0]:null,y=!o||b=="_id"?"dateAdded":b=="pages"?"pages":"title_ci",j=b&&o[b]==-1?"prev":void 0;return S("books",y,{predicate:s,skip:l,cursorSkip:u,limit:c,idxDir:j}).then(p("allBooks","Books"))}function S(e,t=null,{predicate:n,idxDir:r,cursorSkip:a,skip:o,limit:s}={}){return n||(n=()=>!0),new Promise(c=>{d(i=>{let u=i.transaction(e).objectStore(e),b=t?u.index(t).openCursor(null,r):u.openCursor(r),y=[],j=0,h=!1;b.onsuccess=k=>{let w=k.target.result;if(a&&!h)return h=!0,w.advance(a);if(!w)return c(y);let O=w.value;if(n(O)&&(o&&j<o?j++:y.push(O),s&&y.length==s))return c(y);w.continue()}})})}function m(e,t,n,{transformItem:r=a=>a}={}){return new Promise(a=>{if(!t)return a();let o=0;s();function s(){let c=t[o++];if(!c)return a();let l=e.transaction(n,"readwrite").objectStore(n);l.add(r(c)).onsuccess=s}})}async function W(){for(let e of["books","subjects","tags"])await V(e)}async function V(e){return new Promise(t=>{d(async n=>{let r=n.transaction(e,"readwrite");r.objectStore(e).clear().onsuccess=t})})}async function g(e){let t=await _();return new Promise(n=>{d(r=>{let o=r.transaction("syncInfo","readwrite").objectStore("syncInfo");typeof e=="function"?t=e(t):Object.assign(t,e),o.put(t).onsuccess=n})})}function C(e,t){return new Promise(n=>{d(r=>{let o=r.transaction(t,"readwrite").objectStore(t);o.delete(e).onsuccess=n})})}async function L({request:e,response:t},n,r=a=>a){let a=`create${n}`;t&&t.data&&t.data[a]&&t.data[a][n]&&f(r(t.data[a][n]),`${n.toLowerCase()}s`);let o=`update${n}`;t&&t.data&&t.data[o]&&t.data[o][n]&&f(r(t.data[o][n]),`${n.toLowerCase()}s`);let s=`update${n}s`;t&&t.data&&t.data[s]&&t.data[s][n+"s"]&&t.data[s][n+"s"].forEach(i=>f(r(i),`${n.toLowerCase()}s`));let c=`delete${n}`;if(t&&t.data&&t.data[c]){let i=await e.json();C(i.variables._id,n.toLowerCase()+"s")}}function H(e){e&&e.data&&e.data.updateSubject&&e.data.updateSubject.forEach(t=>f(t,"subjects"))}async function f(e,t,n=r=>r){if(!!(await _()).currentUser)return new Promise(o=>{d(s=>{let i=s.transaction(t,"readwrite").objectStore(t);i.get(e._id).onsuccess=({target:{result:l}})=>{l?(Object.assign(l,n(e)),i.put(l).onsuccess=o):i.add(n(e)).onsuccess=o}})})}var P=20,$=25,B=14,K=15,M=6;function N(e,t){return g(n=>(n.usersSyncd[e]=Object.assign(n.usersSyncd[e]||{},{lastSync:t}),n))}async function X(e,t){let n=`/graphql/?query=${K}&variables=${JSON.stringify({timestamp:t})}`,{data:r}=await v(n).then(a=>a.json());for(let a of r.allBooks.Books)await f(a,"books",x);for(let a of r.allSubjects.Subjects)await f(a,"subjects");for(let a of r.allTags.Tags)await f(a,"tags");for(let{_id:a}of r.deletedBooks._ids)await C(a,"books");for(let{_id:a}of r.deletedSubjects._ids)await C(a,"subjects");for(let{_id:a}of r.deletedTags._ids)await C(a,"tags");await N(e,+new Date)}function Y(e){d(t=>{Promise.all([new Promise(n=>T(t,n)),Z(t),ee(t),te(t)]).then(()=>N(e,+new Date))})}function T(e,t,n=1){let r=50;I(M,{page:n,pageSize:r},"allBooks","Books").then(a=>{m(e,a,"books",{transformItem:o=>Object.assign(o,{imgSync:0,title_ci:(o.title||"").toLowerCase()})}).then(()=>{a.length==r?T(e,t,n+1):ne(e,t)})})}function Z(e){return I(P,{},"allSubjects","Subjects").then(t=>m(e,t,"subjects"))}function ee(e){return I($,{},"allTags","Tags").then(t=>m(e,t,"tags"))}async function te(e){if(!(await Q("labelColors")>0))return I(B,{},"allLabelColors","LabelColors").then(t=>m(e,t,"labelColors"))}async function ne(e,t){let o=e.transaction("books").objectStore("books").index("imgSync").openCursor(0),s=[];o.onsuccess=i=>{let l=i.target.result;if(!l)return c();let u=l.value;s.push({_id:u._id,smallImage:u.smallImage}),l.continue()};async function c(){t()}}function I(e,t,n,r){return v(`/graphql/?query=${e}&variables=${JSON.stringify(t)}`).then(a=>a.json()).then(a=>a.data&&a.data[n]&&a.data[n][r])}var ae=5;self.addEventListener("push",()=>{self.registration.showNotification("Push notification received!")});self.addEventListener("message",async e=>{e.data&&e.data.command=="do-sync"&&(await g({currentUser:e.data.userId}),R(e.data.userId))});self.addEventListener("message",async e=>{e.data&&e.data.command=="login"&&(await g({currentUser:e.data.userId}),R(e.data.userId))});self.addEventListener("message",async e=>{e.data&&e.data.command=="logged-out"&&(await g({currentUser:null,usersSyncd:{}}),await W())});self.addEventListener("fetch",e=>{let t=e.request.clone();if(/\bgraphql\b/.test(t.url)){if(/get/i.test(t.method))return e.respondWith(re(t));if(/post/i.test(t.method))return e.respondWith(oe(t))}});function re(e){return fetch(e).catch(t=>{let n=e.url.split("?")[1],{query:r,variables:a}=D(n);if(r==B)return S("labelColors","order").then(p("allLabelColors","LabelColors"));if(r==P)return S("subjects","name").then(p("allSubjects","Subjects"));if(r==$)return S("tags","name").then(p("allTags","Tags"));if(r==ae)return z(a)})}function oe(e){let t=e.clone();return fetch(e).then(n=>(console.log(t),n.clone().json().then(a=>{L({request:t,response:a},"Book",x),L({request:t,response:a},"Tag"),H(a)}),n))}function R(e){const t=1500*10;d(async n=>{await g({currentUser:e});let a=(await _()).usersSyncd[e];a?Date.now()-a.lastSync>t&&X(e,a.lastSync):Y(e)})}
